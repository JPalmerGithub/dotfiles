#! /usr/local/bin/python2.6

from subprocess import (
    Popen,
    PIPE,
    )
import time
from datetime import datetime
from pprint import pformat
from smtplib import SMTP

_DB4 = "holmesdb4.mn.visi.com"

databases = [
  ("IFMA FMP", ["-h", "localhost", "-p", "5433", "ifmafmp10"]),
  ("IFMA SFP", ["-h", "localhost", "-p", "5433", "ifmasfp10"]),
  ("IIA CIA30", ["-h", _DB4, "-p", "5432", "iiacia30v2"]),
  ("AFP Treasury", ["-h", "localhost", "-p", "5432", "afptreasury30"]),
  ("SHRM EHRM", ["-h", "localhost", "-p", "9999", "shrmehrm"]),
  ]

SQL_CMD = ["-c", """DELETE FROM content WHERE content_id IN (SELECT CASE WHEN newer_status='inited' THEN newer_content_id WHEN older_status='inited' THEN older_content_id END AS content_id FROM risky_results WHERE older_status='inited' OR newer_status='inited');"""]

PSQL = ["/usr/local/pgsql/bin/psql", "-U", "postgres"]

data = ['']

for nm, db in databases:
    data.extend([(' ' + nm + ' ').center(60, '*'), ''])
    p1 = Popen(PSQL + db + SQL_CMD, stdout=PIPE)
    data.extend(p1.communicate()[0].splitlines())
    data.append('')

#print pformat(data)
